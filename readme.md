# RictWorld 项目实现文档（存档实体版）

## 1. rictworld/src/main.py

**模块导入**：导入grid模块、ui.viewers模块以及entities文件夹下的所有实体类，包括新增的save_entity。

**Pygame初始化**：调用pygame初始化函数，设置屏幕大小为预设的宽度和高度，创建显示窗口。

**Grid初始化**：创建Grid实例，初始化实体列表和实体位置索引字典。

**实体添加**：在网格中添加玩家实体，设置初始网格坐标；添加树实体作为环境元素；添加Pig实体（使用AI行为）；添加存档实体，分别设置各自的网格坐标。

**Viewer初始化**：创建Viewer实例，传入屏幕对象、网格实例、玩家实体引用和网格单元大小（像素尺寸）。

**游戏循环**：
- 事件监听：处理键盘事件（上下左右键控制移动，空格键触发交互）；处理触摸事件（滑动手势对应移动，双击对应交互）
- 玩家移动处理：当玩家移动时，更新其方向属性以保持朝向正确
背包状态管理：处理背包打开/关闭状态下的不同输入映射
- 定时更新：检查时间间隔，超过0.5秒则调用网格更新方法和视图更新方法
- 屏幕刷新：每次循环结束时刷新显示
2. rictworld/src/grid.py
构造函数：初始化实体字典（键为(i,j)网格坐标，值为实体对象）。
add_entity函数：接收一个实体对象作为参数，获取实体的网格坐标(i,j)，检查该坐标是否已被占用（通过实体字典），如果未被占用则将实体添加到实体字典。
remove_entity函数：接收一个实体对象作为参数，从实体字典中移除该实体。
update函数：遍历实体字典中的每个实体，调用它们的update方法进行状态更新，接收返回值（1.None 不操作，2.返回值 ['delete',(i,j)],3.返回值[],创建实体），对于移动的实体，更新其在实体字典的键值。
is_valid_position函数：接收网格坐标(i,j)，检查该坐标是否在实体字典中，返回布尔值表示位置是否有效。
get_entity_at函数：接收网格坐标(i,j)，返回该位置的实体，如果不存在则返回None。
get_entities_in_rect函数：接收矩形区域的左上角(top_left_i, top_left_j)和右下角(bottom_right_i, bottom_right_j)坐标，返回该矩形区域内所有实体的字典。
serialize函数：将当前网格状态序列化为JSON格式，包括所有实体的类型、位置和状态信息。
deserialize函数：从JSON数据中重建网格状态，清除当前所有实体，然后根据数据创建并添加新的实体。
3. rictworld/src/ui/viewer.py
模块导入：导入font模块用于文本渲染，导入os和pygame模块用于图像加载。
构造函数：接收screen（pygame屏幕对象）、grid（网格实例）、player（玩家实体）和cell_size（网格单元像素大小）作为参数，初始化这些属性，并创建字体对象。添加图像缓存字典属性。
draw_grid函数：根据屏幕大小和网格单元大小，计算需要绘制的网格线位置，使用线条绘制函数在屏幕上绘制可见区域的网格线。
draw_entities函数：玩家位置在屏幕中心，计算屏幕范围内的实体（通过网格的get_entities_in_rect方法快速查找矩形区域），将实体网格坐标转换为屏幕像素坐标，从图像缓存字典中获取每个实体的预加载图像，在对应位置绘制实体图像。
draw_bag函数：在屏幕角落显示玩家背包内容，显示背包中物品的图标和数量，高亮显示当前选中的物品槽位。

draw_chest函数：当玩家与箱子交互时显示箱子库存，显示箱子库存和玩家背包的对比界面，提供物品移动的视觉反馈。

draw_interaction_hint函数：显示与实体交互的提示，当玩家靠近可交互实体时显示相应提示图标。

draw函数：首先清空屏幕，然后调用draw_grid函数绘制网格，再调用draw_entities函数绘制所有可见实体，根据游戏状态决定是否绘制背包或箱子界面，最后更新显示。
图像获取函数：接收图像路径作为参数，从图像缓  存字典中返回对应的图像表面，如果不存在则尝试加载(使用与图像路径拼接路径)与resize并缓存。

## 4. rictworld/src/ui/font.py

**构造函数**：初始化字体路径为项目根目录与"rictworld/assets/font/华文行楷.ttf"拼接。

**render_text函数**：接收文本内容、字体大小和颜色作为参数，加载指定大小的字体文件，将文本渲染为指定颜色的图像表面，返回该表面对象。


5. rictworld/src/entities/base_entity.py
构造函数：接收网格坐标(i,j)和action作为参数，设置实体的网格坐标属性；设置image路径为默认图像路径；初始化其他基础属性。初始化背包属性为空字典，设置背包容量限制。存储action参数用于后续处理。

update函数：检查action参数，根据不同的action类型执行相应操作：

如果action是{"automove":True}，则随机选择一个方向（上、下、左、右），调用move函数向该方向移动

如果action是{'move':(dx,dy)}，调用move函数按照dx和dy参数移动

如果action是{'interact':(i,j)}，调用interact函数与指定坐标(i,j)的实体交互

如果action是{'pickup':(i,j)}，调用pickup函数捡起指定坐标(i,j)的实体

如果action是{'place':(i,j)}，调用place函数在指定坐标(i,j)放置实体

执行完动作后，清空action参数，防止重复执行

move函数：接收dx和dy参数作为移动的网格坐标偏移量，更新实体的网格坐标。返回移动结果状态，如是否成功移动。

interact函数：接收目标坐标(i,j)作为参数，获取该位置的实体，调用其实体的interact方法。返回交互结果，如是否成功交互、获得的物品等。

pickup函数：接收目标坐标(i,j)作为参数，获取该位置的实体，调用store_item方法将其添加到背包。返回拾取结果，如是否成功拾取。

place函数：接收目标坐标(i,j)作为参数，从背包中取出指定物品，调用网格的add_entity方法将其放置到目标位置。返回放置结果，如是否成功放置。

store_item函数：接收实体对象作为参数，检查背包容量，如果未满则将实体添加到背包，从网格中移除被存储的实体，更新背包物品计数。返回存储结果。

take_item函数：接收物品标识符作为参数，从背包中查找并移除指定物品，将取出的实体放置到玩家当前位置或相邻位置，更新背包物品计数。返回取出的实体对象。

set_action函数：接收action字典作为参数，设置实体的当前动作。此函数用于外部控制实体的行为。

clear_action函数：清空实体的当前动作，用于重置状态。

## 6. rictworld/src/entities/ai_entity.py

**继承**：继承自base_entity类，获得所有基础实体功能。

**构造函数**：接收网格坐标(i,j)作为参数，调用父类构造函数，设置自动移动标志为True，覆盖image路径为Pig专用图像。

## 7. rictworld/src/entities/player_entity.py

**继承**：继承自base_entity类，获得所有基础实体功能。

**构造函数**：接收网格坐标(i,j)作为参数，调用父类构造函数，设置方向属性初始值为空，覆盖image路径为玩家专用图像。


**交互函数**：根据当前方向属性计算相邻位置的网格坐标，通过网格的get_entity_at方法获取该位置的实体，如果存在实体则调用该实体的interact方法（传入玩家自身作为参数）。
背包序列化：添加背包状态到玩家序列化数据中，确保存档和读档时背包内容保持一致。

## 8. rictworld/src/entities/tree_entity.py

**继承**：继承自base_entity类，获得所有基础实体功能。

**构造函数**：接收网格坐标(i,j)作为参数，调用父类构造函数，设置自动移动标志为False，覆盖image路径为树专用图像。

**interact函数**：重写父类的interact方法，实现与树木的特定交互行为（如采集资源等）。

## 9. rictworld/src/entities/save_entity.py

**继承**：继承自base_entity类，获得所有基础实体功能。

**构造函数**：接收网格坐标(i,j)和grid引用作为参数，调用父类构造函数，设置自动移动标志为False，覆盖image路径为存档实体专用图像，保存grid引用，初始化存档数据为空。

**interact函数**：重写父类的interact方法，根据交互者（玩家）相对于存档实体的位置执行不同操作：
- 如果玩家在存档实体上方：调用grid的serialize方法将当前游戏状态保存到存档数据中
- 如果玩家在存档实体下方且存档数据不为空：调用grid的deserialize方法从存档数据中恢复游戏状态

**serialize方法**：调用grid的serialize方法获取当前游戏状态的序列化数据，并存储在存档数据属性中。

**deserialize方法**：如果存档数据不为空，调用grid的deserialize方法从存档数据中恢复游戏状态。

**has_save_data函数**：返回布尔值，表示该存档实体是否有存储的存档数据。

**clear_save_data函数**：清空存档实体中存储的存档数据。

## 10. rictworld/src/entities/chest_entity.py
继承：继承自base_entity类，获得所有基础实体功能。

构造函数：接收网格坐标(i,j)作为参数，调用父类构造函数，设置自动移动标志为False，覆盖image路径为箱子图像，初始化箱子库存为空字典，设置箱子容量限制。

interact函数：重写父类的interact方法，当玩家与箱子交互时，打开箱子库存界面。

add_item函数：接收物品实体作为参数，向箱子添加物品。

remove_item函数：接收物品标识符作为参数，从箱子移除物品。

get_inventory函数：返回箱子当前库存。

序列化支持：实现箱子状态的序列化和反序列化，确保存档时保存箱子库存内容。